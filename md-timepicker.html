<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../font-roboto/roboto.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../paper-shadow/paper-shadow.html">
<link rel="import" href="../paper-button/paper-button.html">
<!-- Why this ? see http://stackoverflow.com/questions/24947683/polymer-conflict-with-moment-js -->
<link rel="import" href="imports/moment.html">

<!--
Element that let the user input a time easily.

##### Example

    <md-timepicker></md-timepicker>

@element md-timepicker
@blurb Element that let the user input a time easily.
@status alpha
@homepage https://github.com/virtual-dev/md-timepicker
-->
<polymer-element name="md-timepicker" attributes="color">
    <template>
        <style>
            *{
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            #card {
                height: 400px;
                width: 250px;
                margin: 20px auto;
                font-family: 'RobotoDraft', 'Helvetica Neue', Helvetica, sans-serif;
                color: rgba(0,0,0,0.54);
                background-color: white;
            }
            #display {
                box-sizing: border-box;
                height: 120px;
                padding: 24px;
                color: white;
                font-size: 46px;
                font-weight: 100;
            }
            #display .digit{
                padding: 5px;
                -webkit-transition: .5s cubic-bezier(1,-1.2,0.2,2);
                -moz-transition: .5s cubic-bezier(1,-1.2,0.2,2);
                -o-transition: .5s cubic-bezier(1,-1.2,0.2,2);
                transition: .5s cubic-bezier(1,-1.2,0.2,2);
            }
            #display .digit[active]{
                -webkit-transform: scale(1.2);
                -moz-transform: scale(1.2);
                -o-transform: scale(1.2);
                -ms-transform: scale(1.2);
                transform: scale(1.2);
            }
            #keypad{
                box-sizing: border-box;
                font-size: 42px;
                font-weight: 300;
            }
            #keypad .digit{
                flex: 1 0 63px;
                /* shorthand for
                flex-grow: 1;
                flex-shrink: 0;
                flex-basis: 63px;*/
            }
            #keypad .digit[disabled]{
                color: rgba(0,0,0,0.12);
            }
            /* second child because <template></template> comes before */
            #keypad .digit:nth-child(2){
                /* we put the 0 at the bottom */
                order: 10;
            }
            .digit{
                border-radius: 50%;
                position: relative;
                text-align: center;
            }
            #button_bar{
                font-size: 14px;
            }
            #done_button{
                color: #4285f4;
            }
            #done_button,
            #clear_button{
                margin: 5px;
            }
        </style>
        <div id="card" layout vertical justified>
            <paper-shadow z="2"></paper-shadow>
            <div id="display" center center-justified horizontal layout style="background-color:{{color}}">
                <div id="hours" class="digit" on-click="{{selectHours}}" active?="{{currentSelector == selector.HOUR}}">
                    <paper-ripple fit class="circle recenteringTouch"></paper-ripple>
                    {{hours}}
                </div>
                <span>:</span>
                <div id="minutes" class="digit" on-click="{{selectMinutes}}" active?="{{currentSelector == selector.MINUTE}}">
                    {{minutes}}
                    <paper-ripple fit class="circle recenteringTouch"></paper-ripple>
                </div>
            </div>
            <div id="keypad" layout horizontal center-justified center wrap flex>
                <template repeat="{{key in keys}}">
                    <div class="digit" disabled?="{{!key.enabled}}" on-click="{{keyPressed}}">
                        {{key.value}}
                        <template if="{{key.enabled}}">
                            <paper-ripple fit class="circle recenteringTouch"></paper-ripple>
                        </template>
                    </div>
                </template>
            </div>
            <div id="button_bar" layout horizontal justified>
                <paper-button id="clear_button" label="Clear" on-click="{{clearDisplay}}"></paper-button>
                <paper-button id="done_button" label="Done" on-click="{{generateDate}}" autofocus?="{{currentSelector == selector.DONE}}"></paper-button>
            </div>
        </polymer-ui-card>
    </template>
    <script>
    Polymer({
        /**
        * The `color` attribute sets a background-color for the header
        *
        * @attribute color
        * @type string
        * @default '#5264ae'
        */
        color: "#5264ae",
        created: function() {
            // Enum for the current selected number
            this.selector = {
                HOUR : "HOUR",
                MINUTE : "MINUTE",
                DONE : "DONE"
            }
            // Start with HOUR
            this.currentSelector = this.selector.HOUR;

            // Enum for the current selected digit inside a number
            this.cursor = {
                DECADE : "DECADE",
                UNIT : "UNIT"
            }
            // Start with the leftmost digit (DECADE)
            this.currentCursor = this.cursor.DECADE;

            // initialize the displayed time to Now
            var now = moment();
            this.hours = now.format("HH");
            this.minutes = now.format("mm");

            // list ok keys on the keyad
            this.keys = [
                {value: 0, enabled: true},
                {value: 1, enabled: true},
                {value: 2, enabled: true},
                {value: 3, enabled: true},
                {value: 4, enabled: true},
                {value: 5, enabled: true},
                {value: 6, enabled: true},
                {value: 7, enabled: true},
                {value: 8, enabled: true},
                {value: 9, enabled: true}
            ];
        },
        /**
        * The `selectHours` method will focus the hours.
        *
        * @method selectHours
        */
        selectHours: function(event, detail, sender){
            // when user clicks on the HOUR part on display we update
            // corresponding variables and enable eventually disabled keys.
            if(this.currentSelector != this.selector.HOUR)
                this.currentSelector = this.selector.HOUR;
            this.currentCursor = this.cursor.DECADE;
            this.enableKeys();
        },
        /**
        * The `selectMinutes` method will focus the minutes.
        *
        * @method selectMinutes
        */
        selectMinutes: function(event, detail, sender){
            // same here for MINUTE
            if(this.currentSelector != this.selector.MINUTE)
                this.currentSelector = this.selector.MINUTE;
            this.currentCursor = this.cursor.DECADE;
            this.enableKeys();
        },
        /**
        * The `keyPressed` method will input the number to the focused zone
        *
        * @method keyPressed
        */
        keyPressed: function(event, detail, sender){
            // the key emitting the event
            var keyObject = sender.templateInstance.model.key;
            var key = sender.templateInstance.model.key.value;

            // if pressed key is disabled stop here
            if(!keyObject.enabled)
                return;

            if(this.currentSelector == this.selector.HOUR){
                if(this.currentCursor == this.cursor.DECADE){
                    // if first HOUR digit is 2 we disable keys from 4 because
                    // maximum HOUR is 24
                    if(key == 2)
                        this.disableKeys(4);
                    // if first HOUR digit is 0 or 1 or 2 we clear the second
                    // digit to 0 to show user which digit is focused next
                    if(key < 3){
                        this.hours = key.toString() + "0";
                        this.currentCursor = this.cursor.UNIT;
                    }
                    // if first key pressed is 3 or more we consider it's the
                    // second digit automatically so we put a 0 on the first digit
                    else{
                        this.hours = "0" + key.toString();
                        this.currentSelector = this.selector.MINUTE;
                    }
                }
                else if(this.currentCursor == this.cursor.UNIT){
                    // for second HOUR digit we keep the first digit intact
                    this.hours = this.hours.substring(0,1) + key.toString();
                    // then we move to the first digit of MINUTE
                    this.currentSelector = this.selector.MINUTE;
                    this.currentCursor = this.cursor.DECADE;
                    // enable eventually disabled keys
                    this.enableKeys();
                }
            }
            else if(this.currentSelector == this.selector.MINUTE){
                if(this.currentCursor == this.cursor.DECADE){
                    // if first MINUTE digit is less than 6 we clear the second
                    // digit to 0 to show user which digit is focused next
                    // manimum MINUTE beeing 59
                    if(key < 6){
                        this.minutes = key.toString() + "0";
                        this.currentCursor = this.cursor.UNIT;
                    }
                    // if first key pressed is 6 or more we consider it's the
                    // second digit automatically so we put a 0 on the first digit
                    else{
                        this.minutes = "0" + key.toString();
                        this.currentSelector = this.selector.DONE;
                        this.disableKeys(0);
                    }
                }
                else if(this.currentCursor == this.cursor.UNIT){
                    // for second MINUTE digit we keep the first digit intact
                    this.minutes = this.minutes.substring(0,1) + key.toString();
                    // we're done
                    this.currentSelector = this.selector.DONE;
                    this.disableKeys(0);
                }
            }
        },
        /**
        * The `disableKeys` method will disable keys from startKey to 9 (included)
        *
        * @method disableKeys
        * @param {Int} the lowest key to disable.
        */
        disableKeys: function(startKey){
            // disables key(s) from start to 9 (both included)
            for(var i = startKey; i<10; i++)
                this.keys[i].enabled = false;
        },
        /**
        * The `enableKeys` method will enable all keys
        *
        * @method enableKeys
        */
        enableKeys : function(){
            // (re)enables all keys
            for(var i = 0; i<10; i++)
                this.keys[i].enabled = true;
        },

        /**
        * The `time-selected event is fired whenever we
        * call generateDate.
        *
        * @event time-selected
        * @param {Object} detail
        *   @param {string} detail.time The time formatted as "HH:mm".
        */

        /**
        * The `generateDate` method will fire the time-selected.
        *
        * @method generateDate
        */
        generateDate: function(){
            this.currentSelector = this.selector.DONE;
            this.disableKeys(0);

            var today = moment();
            today.hours(this.hours);
            today.minutes(this.minutes);
            // this.fire('time-selected', {time: today}); // a moment Object
            // this.fire('time-selected', {time: today.toDate()}); // a Date Object
            this.fire('time-selected', {time: today.format('HH:mm')}); // a String
        },
        /**
        * The `clearDisplay` method will reset the display to the actual time,
        * enable eventually disabled key, and set the focus to the hours
        *
        * @method clearDisplay
        */
        clearDisplay: function(){
            // clear to Now, reset variables and enable eventually disabled keys
            var now = moment();
            this.hours = now.format("HH");
            this.minutes = now.format("mm");
            this.currentSelector = this.selector.HOUR;
            this.currentCursor = this.cursor.DECADE;
            this.enableKeys();
        }
    })
    </script>
</polymer-element>
